generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Product {
  id          Int      @id @default(autoincrement())
  name        String
  description String?
  price       Float
  stock       Int
  imageUrl    String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  categoryId  Int

  category     Category                 @relation(fields: [categoryId], references: [id])
  productUnits ProductUnitMeasurement[] // Relación muchos a muchos
  orderItems   OrderItem[]

  // <-- campo inverso para PurchaseItem (no crea columna nueva en Product)
  purchaseItems PurchaseItem[]
}

model Category {
  id       Int       @id @default(autoincrement())
  name     String    @unique
  products Product[]
}

model UnitMeasurement {
  id           Int                      @id @default(autoincrement())
  name         String                   @unique // Ej: "Kg", "Unidades", "L"
  description  String? // Ej: "Kilogramos", "Unidades", "Litros"
  productUnits ProductUnitMeasurement[] // Relación muchos a muchos
  OrderItem    OrderItem[]

  // <-- campo inverso para PurchaseItem
  purchaseItems PurchaseItem[]
}

model ProductUnitMeasurement {
  id                Int @id @default(autoincrement())
  productId         Int
  unitMeasurementId Int

  product         Product         @relation(fields: [productId], references: [id])
  unitMeasurement UnitMeasurement @relation(fields: [unitMeasurementId], references: [id])

  @@unique([productId, unitMeasurementId]) // Evitar duplicados
}

model Company {
  id    Int    @id @default(autoincrement())
  name  String @unique
  color String @default("#CCCCCC") // Color por defecto agregado
  areas Area[] // Un área pertenece a una empresa, una empresa tiene varias áreas
}

model Area {
  id        Int    @id @default(autoincrement())
  name      String
  color     String @default("#CCCCCC")
  companyId Int

  company Company @relation(fields: [companyId], references: [id])
  users   User[]
  orders  Order[]

  // <-- campo inverso para Purchase
  purchases Purchase[]
}

model User {
  id        Int      @id @default(autoincrement())
  firstName String
  lastName  String
  email     String   @unique // El mismo correo puede ser usado por diferentes usuarios (áreas)
  phone     String?
  address   String?
  password  String
  role      String // admin o customer
  areas     Area[] // Un usuario puede estar asociado a varias áreas de la misma empresa
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  orders Order[] // Un usuario puede tener varias órdenes
}

model Order {
  id          Int      @id @default(autoincrement())
  areaId      Int
  totalAmount Float
  status      String // Ej: "created", "delivered", etc.
  observation String? // <- Campo agregado
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  area       Area        @relation(fields: [areaId], references: [id]) // La orden pertenece a un área
  orderItems OrderItem[] // Un pedido puede tener varios productos
  User       User?       @relation(fields: [userId], references: [id])
  userId     Int?
}

model OrderItem {
  id                Int   @id @default(autoincrement())
  orderId           Int
  productId         Int
  quantity          Float
  price             Float
  unitMeasurementId Int

  order           Order           @relation(fields: [orderId], references: [id])
  product         Product         @relation(fields: [productId], references: [id])
  unitMeasurement UnitMeasurement @relation(fields: [unitMeasurementId], references: [id])
}

// --- Nuevos modelos para compras/proveedores (añadir tablas nuevas) ---

model Supplier {
  id          Int      @id @default(autoincrement())
  name        String
  companyName String?
  contactName String?
  phone       String?
  email       String?  @unique
  address     String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  purchases Purchase[]
}

model Purchase {
  id          Int       @id @default(autoincrement())
  supplierId  Int
  areaId      Int?
  totalAmount Float
  status      String // e.g. "created", "paid", "pending", "cancelled"
  paid        Boolean   @default(false)
  paymentDate DateTime?
  observation String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  supplier      Supplier       @relation(fields: [supplierId], references: [id])
  purchaseItems PurchaseItem[]
  area          Area?          @relation(fields: [areaId], references: [id])
}

model PurchaseItem {
  id                Int      @id @default(autoincrement())
  purchaseId        Int
  productId         Int? // usa tu tabla Product existente si aplica
  description       String? // "Saco de cebolla"
  quantity          Float
  unitMeasurementId Int? // opcional: referencia UnitMeasurement existente
  unitCost          Float // costo por unidad (lo que pagaste)
  totalCost         Float // quantity * unitCost
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  purchase        Purchase         @relation(fields: [purchaseId], references: [id])
  product         Product?         @relation(fields: [productId], references: [id])
  unitMeasurement UnitMeasurement? @relation(fields: [unitMeasurementId], references: [id])

  @@index([purchaseId])
}
